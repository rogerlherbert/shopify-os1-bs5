{% assign current_variant = product.selected_or_first_available_variant %}

<div class="container">
  <div class="row g-0 mb-3">

    <div class="col-sm-7 mb-3">
      <div id="productImagesCarousel" class="carousel slide d-sm-none">
        <div class="carousel-indicators">
          {% assign slideCounter = 1 %}
          {% for image in product.images %}
            <button type="button" data-bs-target="#productImagesCarousel" data-bs-slide-to="{{ slideCounter | minus: 1 }}"{% if forloop.first == true %} class="active"{% endif%} aria-current="true" aria-label="Slide {{ slideCounter }}"></button>
            {% assign slideCounter = slideCounter | plus: 1 %}
          {% endfor %}
        </div>
        <div class="carousel-inner">
          {% for image in product.images %}
            <div class="carousel-item{% if forloop.first == true %} active{% endif%}">
              <img src="{{ image.src | img_url: '576x', scale: 2 }}" class="d-block img-fluid" width="{{ image.width }}" height="{{ image.height }}" loading="lazy" alt="{{ image.alt | escape }}">
            </div>
          {% endfor %}
        </div>
      </div>

      <div id="productImagesGrid" class="d-none d-sm-block">
      {% for image in product.images %}
          <img src="{{ image.src | img_url: '768x', scale: 2 }}" class="img-fluid" width="{{ image.width }}" height="{{ image.height }}" loading="lazy" alt="{{ image.alt | escape }}">
      {% endfor %}
      </div>
    </div>

    <div class="col-sm-5">
      <div class="mx-sm-3 position-sticky" style="top: 60px;">
        <div><a href="{{ routes.root_url }}">Home</a> / {% if collection %}<a href="{{ collection.url }}">{{ collection.title }}</a> /{% endif %}</div>
        <h1>{{ product.title }}</h1>
        <p>{{ current_variant.price | money }}</p>

        <form action="/cart/add" method="post" enctype="multipart/form-data" id="AddToCartForm">
          <div class="mb-3">
            <select name="id" id="productSelect" class="form-select">
              {% for variant in product.variants %}
                {% if variant.available %}
                  <option value="{{ variant.id }}">
                    {{ variant.title }} - {{ variant.price | money_with_currency }}
                  </option>
                {% else %}
                  <option disabled="disabled">
                    {{ variant.title }} - sold out
                  </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="d-grid gap-2 mb-3">
            <button type="submit" name="add" id="AddToCart" class="btn btn-primary btn-lg">Add to cart</button>
          </div>
        </form>

        <script src="{{ 'option_selection.js' | shopify_asset_url }}" defer></script>
        <script>
          var selectCallback = function(variant, selector) {
            // change ATC button state

            if (typeof variant !== "undefined" && variant !== null) {
              if (variant.available) {
                // variant available
                enableSubmitButton();

                // TODO - change price
                // TODO - change variant image
              } else {
                // defined, but not available
                disableSubmitButton();

                // TODO - change price
                // TODO - change variant image
              }
            } else {
              // undefined or null
              disableSubmitButton();

            }
          }

          function disableSubmitButton(){
            let btn = document.querySelector("#AddToCart");
            btn.setAttribute("disabled","");
            btn.textContent = "Out Of Stock";
          }

          function enableSubmitButton(){
            let btn = document.querySelector("#AddToCart");
            btn.removeAttribute("disabled","");
            btn.textContent = "Add To Cart";
          }

          // wait for option_selection.js deferred loading
          document.addEventListener('DOMContentLoaded', function(event) {
            new Shopify.OptionSelectors('productSelect', {
              product: {{ product | json }},
              onVariantSelected: selectCallback,
              enableHistoryState: true
            });

            // add BS5 layout classes to new form controls
            let inputGroups = document.querySelectorAll("#AddToCartForm .selector-wrapper");

            inputGroups.forEach(element => {
              let inputLabel = element.querySelector("label");
              let inputSelect = element.querySelector(".single-option-selector");

              element.classList.add("mb-3");

              if (inputLabel !== null) {
                inputLabel.classList.add("form-label");
              }

              if (inputSelect !== null) {
                inputSelect.classList.add("form-select");
              }
            });
          })
        </script>

        <div class="my-5">{{ product.description }}</div>

      </div>
    </div>
  </div>

  {% assign feature_image = images['2048x1152.png'] %}

  <div class="row g-0">
    <div class="col-sm-6"><img class="img-fluid" loading="lazy" width="{{ feature_image.width }}" height="{{ feature_image.height }}" src="{{ feature_image | img_url }}"></div>
    <div class="col-sm-6">
      <div class="h-100 p-5 d-flex flex-column justify-content-center text-center">
        <h3>This is a feature</h3>
        <p>This is some text that talks about the feature with nice SEO-rich keywords included.</p>
      </div>
    </div>
  </div>

  <div class="row g-0">
    <div class="col-sm-6"><img class="img-fluid" loading="lazy" width="{{ feature_image.width }}" height="{{ feature_image.height }}" src="{{ feature_image | img_url }}"></div>
    <div class="col-sm-6 order-sm-first">
      <div class="h-100 p-5 d-flex flex-column justify-content-center text-center">
        <h3>This is a feature</h3>
        <p>This is some text that talks about the feature with nice SEO-rich keywords included.</p>
      </div>
    </div>
  </div>

  <div class="row g-0">
    <div class="col-sm-6"><img class="img-fluid" loading="lazy" width="{{ feature_image.width }}" height="{{ feature_image.height }}" src="{{ feature_image | img_url }}"></div>
    <div class="col-sm-6">
      <div class="h-100 p-5 d-flex flex-column justify-content-center text-center">
        <h3>This is a feature</h3>
        <p>This is some text that talks about the feature with nice SEO-rich keywords included.</p>
      </div>
    </div>
  </div>

  <hr class="my-5 invisible">
  {% section 'product-recommendations' %}
</div>
